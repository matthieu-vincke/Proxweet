<html>
<head>
  <title>Proxweet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <link href="css/themes/default/jquery.mobile-1.2.0.css" rel="stylesheet">
  <script src="js/jquery-1.8.3.js"></script>
  <script src="js/jquery.mobile-1.2.0.js"></script>
  <script>
    var position;
    var wait;
    var refreshOngoing = false;
    var refreshTime = 100;
    function error(txt){
      alert(txt);
    }
    function serverError(){
      error("unable to contact the server");
    }
    function blockWait(){
      wait = true;
    }
    function blockDone(){
      if(!wait) return;
    }
    function cleanTweet(){ 
      $("#events").empty(); 
    }
    function addTweet(user, text){ 
      $("#events").append($("<li/>").text(user + ": " + text)); 
    }
    function redrawTweet(){ 
      $("#events").listview('refresh'); 
    }
    function getTweet(){
      if(!position){
        refreshOngoing = false;
        return error("position not defined");
      }
      $.ajax({
            type: "POST",
            url: "get",
            data: { lng:position.longitude, lat:position.latitude }
        }).done(function( xml ) { 
          cleanTweet();
          $(xml).find('proxweet').each(
            function(elem){addTweet($(this).attr('user'),$(this).text());}
          );
          redrawTweet();
          blockDone();
          refreshOngoing = false;
        })
        .fail(function(){
          refreshOngoing = false;
          serverError();
        });
    }
    function myPosition(p) {
      var infopos = "Position:\n";
      infopos += "Latitude : "+p.coords.latitude +"\n";
      infopos += "Longitude: "+p.coords.longitude+"\n";
      position = {latitude:p.coords.latitude,longitude:p.coords.longitude};
      getTweet();
    }
    function errPosition(error) {
      var info = "Error during the géolocalisation : ";
      switch(error.code) {
      case error.TIMEOUT:
        info += "Timeout !";
      break;
      case error.PERMISSION_DENIED:
      info += "Permission denied";
      break;
      case error.POSITION_UNAVAILABLE:
        info += "Position unavailable";
      break;
      case error.UNKNOWN_ERROR:
        info += "Unknown error";
      break;
      }
      error(info);
    }    
    function refreshLoop(){
      refresh();
      setTimeout(refreshLoop,refreshTime);
    }
    function refresh(){
      if(refreshOngoing) return;
      refreshOngoing = true;
      navigator.geolocation.getCurrentPosition(myPosition, errPosition,{timeout:5000});
    }
    function pushTweet(user, text){
      if(!position) return error("position not defined");
      $.ajax({
            type: "POST",
            url: "post",
            data: { lng:position.longitude, lat:position.latitude, user: user, text: text }
        }).done(function( xml ) { 
          refresh();
        })
        .fail(serverError);
    }
    $(document).bind( 'pageinit', function() {
      blockWait();
      $('#proxweet').keyup(function(e){
        if(e.keyCode == 13){
          pushTweet($('#user').val(),$('#proxweet').val());
          $('#proxweet').val('');
        }
      });
      refresh();
    });
  </script>  
</head>
<body>
  <div data-role="page" id="main">        
    <div data-role="header">
      <h1>proxweeter</h1>
    </div>
  <div data-role="content">  
    <table><tr><td width="15%">
      <input type="text" placeholder="user name" name="user" id="user" value=""/>
    </td><td width="85%">
      <input type="text" placeholder="text" name="proxweet" id="proxweet" value=""/>
    </td></tr></table>
    <h3>ProxPote</h3>
    <ul data-role="listview" data-inset="true" id="events"></ul>
  </div>
</div>
  </body>
</html>    